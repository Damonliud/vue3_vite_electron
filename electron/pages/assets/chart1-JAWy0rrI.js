import{i as J}from"./index-Bb6yjXMn.js";import{_ as K,u as X,r as g,s as Y,j as Z,k as ee,l as te,a as x,b as u,f as N,w as i,d as y,F as V,e as _,m as F,n as P,i as $,g as le,t as O,E as w}from"./index-D8pEwVCS.js";import{u as j,w as ae}from"./xlsx-BWspZQq9.js";const re={__name:"chart1",setup(oe){let I=X();const q=g(),k=g([]),C=g([]);let{quarterExcelData:U,relatedExcelData:b}=Y(I);const p=g([]),n=g({quarterRelated1:"",quarterRelated2:""}),B=g([]),E=g([]),S=async l=>{if(Object.keys(b.value).length==0){w.error("请先导入Excel");return}await l.validate((e,s)=>{if(e){k.value=[n.value.quarterRelated1,n.value.quarterRelated2];let t=p.value.find(r=>r.label==n.value.quarterRelated1).value,a=p.value.find(r=>r.label==n.value.quarterRelated2).value;C.value=[Number(t),Number(a)],L(k.value,C.value)}else console.log("error submit!",s)})};Z(b,()=>{n.value.quarterRelated1="",n.value.quarterRelated2=""},{deep:!0,immediate:!0});let f=null;ee(()=>{if(M(),Object.keys(b.value).length==0)return;p.value=[];for(const e in b.value){let t=b.value[e].reduce((a,r)=>a+r.weightedVelocity,0);p.value.push({value:t.toFixed(2),label:e})}p.value.length>0&&!n.value.quarterRelated1&&(n.value.quarterRelated1=n.value.quarterRelated1||p.value[0].label),p.value.length>1&&!n.value.quarterRelated2&&(n.value.quarterRelated2=n.value.quarterRelated2||p.value[1].label);let l=Object.assign({},U.value,b.value);Q(l),S(q.value)}),te(()=>{f&&(f.dispose(),f=null),window.removeEventListener("resize",D)});let Q=l=>{E.value=[];for(const e in l){let s=l[e].reduce((d,o)=>d+o.cycleTime,0),t=l[e].reduce((d,o)=>d+o.weightedVelocity,0),a=l[e].map(d=>({...d,weight:`${(d.weight*100).toFixed(2)}%`,velocity:d.velocity.toFixed(2),weightedVelocity:d.weightedVelocity.toFixed(2)}));a.push({project:"Total",cycleTime:s,velocity:"Final Velocity",weightedVelocity:t.toFixed(2)});let h={sheetName:e,header:["Projects","Points per PRD","Cycle Time (Day)","Weight","Velocity","Weighted Velocity"],data:a,keys:["project","pointsPerPrd","cycleTime","weight","velocity","weightedVelocity"]};E.value.push(h)}};const z=(l,e)=>{const s=j.book_new();l.forEach(t=>{const{sheetName:a,header:r,data:v,keys:c}=t,m=v.map(o=>c&&c.length>0?c.map(R=>o[R]):Object.values(o)),h=[r,...m],d=j.aoa_to_sheet(h);j.book_append_sheet(s,d,a)});try{ae(s,`${e}.xlsx`),w.success("Excel 文件导出成功！")}catch(t){console.error("Excel 文件导出失败:",t),w.error("Excel 文件导出失败，请重试！")}},A=()=>{z(E.value,"Quarter Related Table")};function M(){const l=document.getElementById("myEcharts");l?(f=J(l),window.addEventListener("resize",D),L(k.value,C.value)):console.error("ECharts 容器 DOM 元素未找到！请检查HTML结构和ID。")}function D(){f&&f.resize()}function L(l=[],e=[]){if(!f){console.error("ECharts 实例未初始化或已销毁！无法更新图表。");return}let s="";if(e.length>=2){const t=e[0],a=e[e.length-1];if(t!==0){const r=(a-t)/t*100;s=`${r>0?"+":""}${r.toFixed(2)}%`,r===0&&(s="持平 (0.00%)")}else s=a>0?"无限增长":"0%"}f.setOption({title:{subtext:`从 ${l[0]} 到 ${l[l.length-1]} 的变化：${s}`,left:"center"},xAxis:{type:"category",data:l},tooltip:{trigger:"axis"},yAxis:{type:"value"},series:[{data:e,type:"line",itemStyle:{normal:{label:{show:!0}}}}]})}const W=l=>{const{columns:e,data:s}=l,t=[];return e.forEach((a,r)=>{if(r===0){t[r]="Total";return}if(r===e.length-2){t[r]="Final Velocity";return}const v=a.property;if(v==="cycleTime"||v==="weightedVelocity"){const c=s.map(m=>Number(m[a.property]));c.every(m=>Number.isNaN(m))?t[r]="N/A":(t[r]=`${c.reduce((m,h)=>{const d=Number(h);return Number.isNaN(d)?m:m+h},0)}`,v==="cycleTime"&&B.value.push(t[r]),v==="weightedVelocity"&&(t[r]=Number(t[r]).toFixed(2)))}}),t},H=()=>{G("png",1,"Quarter Related Chart")},G=(l="png",e=1,s="chart")=>{if(!f){w.error("图表未初始化，无法导出！");return}try{const t=f.getDataURL({type:l,pixelRatio:e,backgroundColor:"#fff"}),a=document.createElement("a");a.href=t,a.download=`${s}.${l}`,document.body.appendChild(a),a.click(),document.body.removeChild(a),w.success(`图表导出为 ${l.toUpperCase()} 成功！`)}catch(t){console.error("导出图表失败:",t),w.error(`导出图表为 ${l.toUpperCase()} 失败，请检查控制台。`)}};return(l,e)=>{const s=y("el-option"),t=y("el-select"),a=y("el-form-item"),r=y("el-button"),v=y("el-form"),c=y("el-table-column"),m=y("el-table"),h=y("el-col"),d=y("el-row");return _(),x(V,null,[u(v,{ref_key:"formRef",ref:q,inline:!0,model:n.value,class:"demo-form-inline"},{default:i(()=>[u(a,{label:"Quarter Related",prop:"quarterRelated1",rules:[{required:!0,message:"Please Select",trigger:"blur"}]},{default:i(()=>[u(t,{modelValue:n.value.quarterRelated1,"onUpdate:modelValue":e[0]||(e[0]=o=>n.value.quarterRelated1=o),placeholder:"Please Select",clearable:""},{default:i(()=>[(_(!0),x(V,null,F(p.value,o=>(_(),P(s,{key:o.label,label:o.label,value:o.label},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(a,{label:"Quarter Related",prop:"quarterRelated2",rules:[{required:!0,message:"Please Select",trigger:"blur"}]},{default:i(()=>[u(t,{modelValue:n.value.quarterRelated2,"onUpdate:modelValue":e[1]||(e[1]=o=>n.value.quarterRelated2=o),placeholder:"Please Select",clearable:""},{default:i(()=>[(_(!0),x(V,null,F(p.value,o=>(_(),P(s,{key:o.label,label:o.label,value:o.label},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(a,null,{default:i(()=>[u(r,{type:"primary",onClick:e[2]||(e[2]=o=>S(q.value))},{default:i(()=>e[3]||(e[3]=[$("Query")])),_:1,__:[3]})]),_:1}),u(a,null,{default:i(()=>[u(r,{type:"primary",onClick:H},{default:i(()=>e[4]||(e[4]=[$("Export Chart")])),_:1,__:[4]})]),_:1}),u(a,null,{default:i(()=>[u(r,{type:"primary",onClick:A},{default:i(()=>e[5]||(e[5]=[$("Export Excel")])),_:1,__:[5]})]),_:1})]),_:1},8,["model"]),e[6]||(e[6]=N("div",{id:"myEcharts",style:{width:"100%",height:"300px"}},null,-1)),u(d,{gutter:20},{default:i(()=>[(_(!0),x(V,null,F(le(b),(o,R)=>(_(),P(h,{lg:{span:12},md:{span:12},sm:{span:24},xs:{span:24},key:R},{default:i(()=>[u(m,{data:o,"show-summary":"","summary-method":W,style:{"margin-top":"20px"}},{default:i(()=>[u(c,{label:R},{default:i(()=>[u(c,{"show-overflow-tooltip":"",prop:"project",label:"Projects"}),u(c,{"show-overflow-tooltip":"",prop:"pointsPerPrd",label:"Points per PRD"}),u(c,{prop:"cycleTime",label:"Cycle Time (Day)"}),u(c,{prop:"weight",label:"Weight"},{default:i(T=>[N("span",null,O(`${(T.row.weight*100).toFixed(2)}%`),1)]),_:1}),u(c,{prop:"velocity",label:"Velocity"}),u(c,{prop:"weightedVelocity",label:"Weighted Velocity"},{default:i(T=>[N("span",null,O(`${T.row.weightedVelocity.toFixed(2)}`),1)]),_:1})]),_:2},1032,["label"])]),_:2},1032,["data"])]),_:2},1024))),128))]),_:1})],64)}}},ie=K(re,[["__scopeId","data-v-6699365f"]]);export{ie as default};
