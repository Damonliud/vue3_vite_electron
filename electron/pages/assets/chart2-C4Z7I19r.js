import{i as J}from"./index-Bb6yjXMn.js";import{_ as K,u as Y,s as Z,r as b,j as ee,k as te,l as le,a as q,b as s,f as T,w as i,d as v,F as V,e as g,m as F,n as P,i as $,g as re,t as Q,E as w}from"./index-D8pEwVCS.js";import{u as S,w as ae}from"./xlsx-BWspZQq9.js";const oe={__name:"chart2",setup(ue){let A=Y(),{quarterExcelData:_,relatedExcelData:O}=Z(A);const x=b(),k=b([]),C=b([]),f=b([]),n=b({quarterRelated1:"",quarterRelated2:""}),B=b([]),E=b([]),j=async l=>{if(Object.keys(_.value).length==0){w.error("请先导入Excel");return}await l.validate((e,u)=>{if(e){k.value=[n.value.quarterRelated1,n.value.quarterRelated2];let t=f.value.find(a=>a.label==n.value.quarterRelated1).value,r=f.value.find(a=>a.label==n.value.quarterRelated2).value;C.value=[Number(t),Number(r)],L(k.value,C.value)}else console.log("error submit!",u)})};ee(_,()=>{n.value.quarterRelated1="",n.value.quarterRelated2=""},{deep:!0,immediate:!0});let y=null;te(()=>{if(U(),Object.keys(_.value).length==0)return;f.value=[],f.value=I(_.value),f.value.length>0&&!n.value.quarterRelated1&&(n.value.quarterRelated1=n.value.quarterRelated1||f.value[0].label),f.value.length>1&&!n.value.quarterRelated2&&(n.value.quarterRelated2=n.value.quarterRelated2||f.value[1].label);let l=Object.assign({},_.value,O.value);M(l),j(x.value)});let I=l=>{const e=new Map;for(const t in l)if(Object.prototype.hasOwnProperty.call(l,t)){const r=l[t],a=t.match(/^(Quarter_\d+)/);if(!a){console.warn(`警告: 键 "${t}" 不符合预期的 "Quarter_X" 格式，已跳过。`);continue}const p=a[1],c=r.reduce((h,d)=>{const o=Number(d.weightedVelocity);return h+(isNaN(o)?0:o)},0),m=e.get(p)||0;e.set(p,m+c)}const u=[];for(const[t,r]of e.entries())u.push({value:Number(r.toFixed(2)),label:t});return u};le(()=>{y&&(y.dispose(),y=null),window.removeEventListener("resize",D)});let M=l=>{E.value=[];for(const e in l){let u=l[e].reduce((d,o)=>d+o.cycleTime,0),t=l[e].reduce((d,o)=>d+o.weightedVelocity,0),r=l[e].map(d=>({...d,weight:`${(d.weight*100).toFixed(2)}%`,velocity:d.velocity.toFixed(2),weightedVelocity:d.weightedVelocity.toFixed(2)}));r.push({project:"Total",cycleTime:u,velocity:"Final Velocity",weightedVelocity:t.toFixed(2)});let h={sheetName:e,header:["Projects","Points per PRD","Cycle Time (Day)","Weight","Velocity","Weighted Velocity"],data:r,keys:["project","pointsPerPrd","cycleTime","weight","velocity","weightedVelocity"]};E.value.push(h)}};function U(){const l=document.getElementById("myEcharts");l?(y=J(l),window.addEventListener("resize",D),L(k.value,C.value)):console.error("ECharts 容器 DOM 元素未找到！请检查HTML结构和ID。")}function D(){y&&y.resize()}function L(l=[],e=[]){if(!y){console.error("ECharts 实例未初始化或已销毁！无法更新图表。");return}let u="";if(e.length>=2){const t=e[0],r=e[e.length-1];if(t!==0){const a=(r-t)/t*100;u=`${a>0?"+":""}${a.toFixed(2)}%`,a===0&&(u="持平 (0.00%)")}else u=r>0?"无限增长":"0%"}y.setOption({title:{subtext:`从 ${l[0]} 到 ${l[l.length-1]} 的变化：${u}`,left:"center"},xAxis:{type:"category",data:l},tooltip:{trigger:"axis"},yAxis:{type:"value"},series:[{data:e,type:"line",itemStyle:{normal:{label:{show:!0}}}}]})}const W=(l,e)=>{const u=S.book_new();l.forEach(t=>{const{sheetName:r,header:a,data:p,keys:c}=t,m=p.map(o=>c&&c.length>0?c.map(R=>o[R]):Object.values(o)),h=[a,...m],d=S.aoa_to_sheet(h);S.book_append_sheet(u,d,r)});try{ae(u,`${e}.xlsx`),w.success("Excel 文件导出成功！")}catch(t){console.error("Excel 文件导出失败:",t),w.error("Excel 文件导出失败，请重试！")}},z=()=>{W(E.value,"Quarter Related Table")},H=l=>{const{columns:e,data:u}=l,t=[];return e.forEach((r,a)=>{if(a===0){t[a]="Total";return}if(a===e.length-2){t[a]="Final Velocity";return}const p=r.property;if(p==="cycleTime"||p==="weightedVelocity"){const c=u.map(m=>Number(m[r.property]));c.every(m=>Number.isNaN(m))?t[a]="N/A":(t[a]=`${c.reduce((m,h)=>{const d=Number(h);return Number.isNaN(d)?m:m+h},0)}`,p==="cycleTime"&&B.value.push(t[a]),p==="weightedVelocity"&&(t[a]=Number(t[a]).toFixed(2)))}}),t},X=()=>{G("png",1,"Quarter Chart")},G=(l="png",e=1,u="chart")=>{if(!y){w.error("图表未初始化，无法导出！");return}try{const t=y.getDataURL({type:l,pixelRatio:e,backgroundColor:"#fff"}),r=document.createElement("a");r.href=t,r.download=`${u}.${l}`,document.body.appendChild(r),r.click(),document.body.removeChild(r),w.success(`图表导出为 ${l.toUpperCase()} 成功！`)}catch(t){console.error("导出图表失败:",t),w.error(`导出图表为 ${l.toUpperCase()} 失败，请检查控制台。`)}};return(l,e)=>{const u=v("el-option"),t=v("el-select"),r=v("el-form-item"),a=v("el-button"),p=v("el-form"),c=v("el-table-column"),m=v("el-table"),h=v("el-col"),d=v("el-row");return g(),q(V,null,[s(p,{ref_key:"formRef",ref:x,inline:!0,model:n.value,class:"demo-form-inline"},{default:i(()=>[s(r,{label:"Quarter",prop:"quarterRelated1",rules:[{required:!0,message:"Please Select",trigger:"blur"}]},{default:i(()=>[s(t,{modelValue:n.value.quarterRelated1,"onUpdate:modelValue":e[0]||(e[0]=o=>n.value.quarterRelated1=o),placeholder:"Please Select",clearable:""},{default:i(()=>[(g(!0),q(V,null,F(f.value,o=>(g(),P(u,{key:o.label,label:o.label,value:o.label},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),s(r,{label:"Quarter",prop:"quarterRelated2",rules:[{required:!0,message:"Please Select",trigger:"blur"}]},{default:i(()=>[s(t,{modelValue:n.value.quarterRelated2,"onUpdate:modelValue":e[1]||(e[1]=o=>n.value.quarterRelated2=o),placeholder:"Please Select",clearable:""},{default:i(()=>[(g(!0),q(V,null,F(f.value,o=>(g(),P(u,{key:o.label,label:o.label,value:o.label},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),s(r,null,{default:i(()=>[s(a,{type:"primary",onClick:e[2]||(e[2]=o=>j(x.value))},{default:i(()=>e[3]||(e[3]=[$("Query")])),_:1,__:[3]})]),_:1}),s(r,null,{default:i(()=>[s(a,{type:"primary",onClick:X},{default:i(()=>e[4]||(e[4]=[$("Export Chart")])),_:1,__:[4]})]),_:1}),s(r,null,{default:i(()=>[s(a,{type:"primary",onClick:z},{default:i(()=>e[5]||(e[5]=[$("Export Excel")])),_:1,__:[5]})]),_:1})]),_:1},8,["model"]),e[6]||(e[6]=T("div",{id:"myEcharts",style:{width:"100%",height:"300px"}},null,-1)),s(d,{gutter:20},{default:i(()=>[(g(!0),q(V,null,F(re(_),(o,R)=>(g(),P(h,{lg:{span:12},md:{span:12},sm:{span:24},xs:{span:24},key:R},{default:i(()=>[s(m,{data:o,"show-summary":"","summary-method":H,style:{"margin-top":"20px"}},{default:i(()=>[s(c,{label:R},{default:i(()=>[s(c,{"show-overflow-tooltip":"",prop:"project",label:"Projects"}),s(c,{"show-overflow-tooltip":"",prop:"pointsPerPrd",label:"Points per PRD"}),s(c,{prop:"cycleTime",label:"Cycle Time (Day)"}),s(c,{prop:"weight",label:"Weight"},{default:i(N=>[T("span",null,Q(`${(N.row.weight*100).toFixed(2)}%`),1)]),_:1}),s(c,{prop:"velocity",label:"Velocity"}),s(c,{prop:"weightedVelocity",label:"Weighted Velocity"},{default:i(N=>[T("span",null,Q(`${N.row.weightedVelocity.toFixed(2)}`),1)]),_:1})]),_:2},1032,["label"])]),_:2},1032,["data"])]),_:2},1024))),128))]),_:1})],64)}}},ie=K(oe,[["__scopeId","data-v-fe130121"]]);export{ie as default};
